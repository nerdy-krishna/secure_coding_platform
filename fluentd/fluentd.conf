# --- SOURCE: Listen for logs from Docker containers ---
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# --- PRE-PROCESS: Extract basic metadata from Tag ---
# Tag format: docker.<service_name>.<container_name>
# We set a default service_name and level here.
<filter docker.**>
  @type record_transformer
  enable_ruby
  <record>
    service_name ${tag_parts[1]}
    level "INFO"
  </record>
</filter>

# --- FILTER: Parse JSON if possible, fallback into 'message' ---
<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true
  <parse>
    @type multi_format
    <pattern>
      format json
    </pattern>
    <pattern>
      format none
      message_key message
    </pattern>
  </parse>
</filter>

# --- MATCH: Forward logs to Grafana Loki ---
<match docker.**>
  @type loki
  @log_level info

  # Loki connection
  url "http://loki:3100"

  # Extract structured labels from the JSON log fields
  <label>
    service_name
    level
    logger_name
  </label>

  # Buffer settings for resilience
  <buffer>
    @type file
    path /fluentd/log/buffer
    flush_interval 5s
    retry_max_times 5
    retry_forever true
  </buffer>
</match>